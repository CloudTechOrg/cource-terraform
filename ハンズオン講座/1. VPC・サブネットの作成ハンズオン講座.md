# 概要
本ハンズオンでは実際にTerraformでAWSリソースの操作を行いTerraformを学習してもらいます
1. VPCの作成
2. VPCの名前の編集
3. Terraformで管理する名前を利用しサブネットの作成
4. VPCとサブネットの削除
の４つをTerraformを用い行っていきます。 \
また途中途中で認証情報の設定やtfstateファイル、ロックファイルなども確認しながらすすめていきます
ではハンズオン始めていきましょう


# 事前準備
## 1. Terraformのインストール
インストールを参照
## 2. VSCodeのインストール
インストールを参照
## 3. アクセスキーとシークレットの準備
事前準備

ではハンズオン始めていきます。
事前準備として
TerraformとVSCodeのインストール済ませておいてください。

また、AWSの認証情報利用しますので、
アクセスキーとシークレットアクセスキーの準備もお願いします。

ではハンズオン進めていきましょう

1. `C:\Terrafrom\Handson\vpc-subnet`フォルダを作成

まずハンズオン用のフォルダを作成していきます。
Cドライブ配下のTerraformにhandsonというハンズオン用のフォルダ作成しそこに
今回利用するvpc-subnetという名前のフォルダを作成します。

こちらフォルダの制約はありませんので、必要に応じてご自身の環境でフォルダ作成してもらえればと思います。

2. main.tfを作成

では次にmain.tfファイルを作成していきます。
右クリックからテキストファイルを作成し、拡張子ごとmain.tfに変更していきます。

警告出ますが、問題ありませんので、そのまま進んでください

3. VSCodeで開く

では作成したmain.tf開いていきます。
初期設定ではVSCodeで開く設定になっていないと思いますので
プロパティから開くプログラムをVSCodeに変更してください
私の場合、すでにVSCodeになっています。
VSCodeの設定になったら適用してOKボタンクリックすればOKです。

これでtfファイルはVSCoddeで開かれるようになります。

4. 拡張機能の紹介

コードを記述する前にVSCodeの拡張機能をご紹介します。
Hashicorp社の公式の拡張機能がVSCodeで利用できますので事前にインストールしましょう。
こちら使うことでTerraformのコードがきれいにシンタックスハイライトで表示されたり、補完機能が使えるようになります

左側のタブの拡張機能をクリックし、検索窓でＴｅｒｒａｆｏｒｍというふうに検索してもらうとHashiCorp社公式のVSCord拡張機能でますので、そちらインストールしてください。

拡張機能のインストール完了しましたらTerraformのコード書いていきましょう。
まずプロバイダブロックからかいていきます。


5. 以下記載して保存
```terraform
provider "aws" {
 region = "ap-northeast-1"
}
```

# 2. terraform initの実行、結果確認

1. terraform initを実行
コマンドを実行すると、awsプロバイダがダウンロードされます。

2. 作成されたフォルダ.terraformとファイル.terraform.look.fileを確認
main.tfのフォルダをみてみると
- .terraform.lock.hclというファイルと
- .terraformというフォルダ
が作成されていることがわかりますね！

まず.terraform.lock.hclを見てみましょう！
こちら複数の環境で同じプロバイダを使うためのロックファイルと呼ばれるファイルになります。
中身をみてみるとproviderのレジストリの情報とバージョン情報が記載されています。
このファイルの場合は
Hashicorp社の公式のレジストリの中のawsプロバイダのバージョン5.81.0を使っていることが書かれていますね！
そして下にハッシュ値が記載されています。

これはawsプロバイダの実行ファイルのハッシュ値になっていて、これによって、同じプロバイダが使われているか検証することができるようになっています。

では実際にプロバイダの方も見ていきましょう！

だいぶ奥のほうになっていますが、プロバイダありましたね！
こちらがawsプロバイダの実態になります。
このハッシュ値はこの実行ファイルのハッシュ値というわけです。

# 3. VPCの作成
ではプロバイダのインストールができたところで早速terraformのコードを書いていきましょう！
main.tfの画面に戻ってください

## 3.1. main.tfを編集（VPC記述）

1. 以下追記
```
resource "aws_vpc" "terra_vpc" {

  cidr_block = "10.0.0.0/16"
  tags = {
    Name = "aws_vpc_name"
  }
}
```

前半戦終了
===

ではリソースブロックの記載が完了しましたので
plan applyをしていきましょう！

main.tfがあるフォルダで右クリックをしてターミナルを開くをクリックします。
もしWindows10を使っている場合はWindows+Rでpowershellを起動して
cd コマンドでmain.tfがあるフォルダをカレントディレクトリにしてください

ここまで完了したらterraform planコマンドを実行します。

はい、エラーとなりました。
エラー読むと認証情報がないと怒られていますね。

まだ認証情報の設定していませんでしたので、設定していきます。

今回はプロセス環境変数に、アクセスキーとシークレットアクセスキーを設定していきます。

powershellのプロセス環境変数にアクセスキー、シークレットアクセスキーを設定する場合このようなコマンドを実行します
こちら説明欄に記載していますのでご参照ください

アクセスキーとシークレットアクセスキーの部分を
ご自身のものに変更してもらいこれをPowershellに打ち込みます。

今回動画用にアクセスキーシークレットアクセスキー表示していますが、こちら絶対に流出してはいけませんので注意してください。
動画作成後このアクセスキーは無効化、削除しています。

```powershell
$Env:AWS_ACCESS_KEY_ID="アクセスキー"
$Env:AWS_SECRET_ACCESS_KEY="シークレットアクセスキー"
```

では認証情報の設定できましたのでterraform plan 実行していきます。

## 3.3. terraform planを実行
1. terraform planを実行
2. 実行結果を確認

実行結果を見てみましょう。
一番上に今回の変更でどのような操作がされるのか記載されています。

createと記載があり+マークのシンボルが記載されています

今回の変更ではVPCが作成されますので 
a

## 3.4. terraform applyを実行

ではplanで変更内容意図したものであること確認できましたので
terraform applyを実行します

1. terraform applyを実行

applyを実行するとplanと同様に変更を行う内容が表示されます。
問題なければyesと入力しEnterをしましょう。

applyが成功しました。

では実際にマネジメントコンソールでリソースを確認してみましょう

2. 作成されたリソースをマネジメントコンソールで確認

VPCのリストみてみると
先ほどmain.tfで書いたaws_vpc_nameという名前のVPCが作成されていることがわかります。
Terraformでリソースを作成することができました！

3. tfstateファイルを確認

また,main.tfがあったフォルダ確認してみると
terraform.tfstateというファイルが作成されていることがわかります。

これはterraformが管理しているAWSリソースの情報が記載されています

中身みてみると
先ほど作成したVPCのリソースterra_vpcの情報がかかれていることがわかります。

arnやcidrブロック、VPCidなど様々な情報が記載されています
tewrraformはこのtfstateファイルを使い、どのリソースを自分が管理しているのかを記憶します

# 4. VPC名の変更
1. tfファイルの編集（VPC名の変更）

では続いてVPCの名前を変更してみましょう。

```
resource "aws_vpc" "terra_vpc" {

  cidr_block = "10.0.0.0/16"
  tags = {
    Name = "aws_vpc_handson"
  }
}
```



2. terraform planを実行
3. 実行結果を確認
4. terraform applyを実行
5. 作成されたリソースをマネジメントコンソールで確認

続いてTerraformが管理している名前のterra_vpcこちらを使ってサブネットを作成したいと思います。

# 5. terraformで管理する名前を使ってサブネットを作成
1. main.tfファイルの編集（Terraformを管理する名前(terra_vpc)を使ってサブネットを作成）
```terraform
resource "aws_subnet" "terra_subnet" {

  vpc_id = aws_vpc.terra_vpc.id

  cidr_block = "10.0.0.0/24"
  tags = {
    Name = "aws_subnet_name"
  }
}
```

2. terraform planを実行
3. 実行結果を確認
4. terraform applyを実行
5. 作成されたリソースをマネジメントコンソールで確認

# 6. リソースの削除

1. main.tfファイルの編集（コメントアウトして削除）
```
# resource "aws_vpc" "terra_vpc" {

#   cidr_block = "10.0.0.0/16"
#   tags = {
#     Name = "aws_vpc_handson"
#   }
# }

# resource "aws_subnet" "terra_subnet" {

#   vpc_id = aws_vpc.terra_vpc.id

#   cidr_block = "10.0.0.0/24"
#   tags = {
#     Name = "aws_subnet_name"
#   }
# }
```
2. terraform planを実行
3. 実行結果を確認
4. terraform applyを実行
5. 作成されたリソースをマネジメントコンソールで確認
6. tfstateファイルを確認
